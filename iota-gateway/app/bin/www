#!/usr/bin/env node

const debug = require('debug')('gateway:app');
const iotaClient = require('@iota/client');
const mqtt = require('mqtt');
const Southbound = require('./southbound');
const Northbound = require('./northbound');

const IOTA_NODE_URL = process.env.IOTA_NODE || 'https://api.thin-hornet-1.h.chrysalis-devnet.iota.cafe';
const IOTA_MESSAGE_INDEX = 'messages/indexation/' + (process.env.IOTA_MESSAGE_INDEX || 'fiware');
global.IOTA_CLIENT = new iotaClient.ClientBuilder().node(IOTA_NODE_URL).build();

const MQTT_BROKER_URL = process.env.MQTT_BROKER_URL || 'mqtt://mosquitto';
global.MQTT_CLIENT = mqtt.connect(MQTT_BROKER_URL);

MQTT_CLIENT.on('connect', () => {
    MQTT_CLIENT.subscribe('/+/+/cmd');
});
MQTT_CLIENT.on('message', Southbound.command);

IOTA_CLIENT.getInfo()
    .then(() => {
        debug('connected to IOTA Tangle: ' + IOTA_NODE_URL);
        debug("Subscribing to '" + IOTA_MESSAGE_INDEX + "/attrs'");
        IOTA_CLIENT.subscriber()
            .topic(IOTA_MESSAGE_INDEX + '/attrs')
            .subscribe((err, data) => {
                if (err) {
                    debug(err);
                } else if (data) {
                    const messageId = getMessageId(data.payload);
                    IOTA_CLIENT.getMessage()
                        .data(messageId)
                        .then((messageData) => {
                            Northbound.measure(messageData)
                        })
                        .catch((err) => {
                            debug(err);
                        });
                }
            });
        debug("Subscribing to '" + IOTA_MESSAGE_INDEX + "/cmdexe'");
        IOTA_CLIENT.subscriber()
            .topic(IOTA_MESSAGE_INDEX + '/cmdexe')
            .subscribe((err, data) => {
                if (err) {
                    debug(err);
                } else if (data) {
                    const messageId = getMessageId(data.payload);
                    IOTA_CLIENT.getMessage()
                        .data(messageId)
                        .then((messageData) => {
                            Northbound.commandResponse(messageData)
                        })
                        .catch((err) => {
                            debug(err);
                        });
                }
            });
    })
    .catch((err) => {
        debug(err);
    });

function getMessageId(payload) {
    let messageId = null;
    try {
        messageId = IOTA_CLIENT.getMessageId(payload);
    } catch (e) {
        messageId = getMessageId(payload);
    }
    return messageId;
}
